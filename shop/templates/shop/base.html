<!DOCTYPE html>
<html lang="fr" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Mon site e-commerce{% endblock %}</title>
    {% comment %} <link rel="icon" type="image/x-icon" href="{% static 'shop/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'shop/styles.css' %}"> {% endcomment %}
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    {% comment %} importation du script du bootstrap {% endcomment %}
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz4fnFO9gybB8c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5sA5" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .footer {
            margin-top: 30vh;
        }
        /* Définir une couleur de base pour l'accentuation (remplacez #ffc107 si nécessaire) */
        :root {
            --bs-primary: #ffc107; /* Typiquement la couleur 'warning' de Bootstrap pour le jaune/or */
            --bs-dark-background: #212529; /* Couleur du fond du footer (bg-dark) */
        }

        /* Style général des liens pour un effet de survol subtil */
        footer a {
            transition: color 0.3s ease-in-out;
            color: rgba(255, 255, 255, 0.75) !important; /* Couleur de lien un peu plus pâle par défaut */
        }

        footer a:hover {
            color: var(--bs-primary) !important; /* Surligner avec la couleur principale du site */
        }

        /* Style pour les titres de section */
        footer h6 {
            color: white;
            letter-spacing: 0.5px; /* Petit espacement pour un look plus moderne */
        }

        /* Style pour l'icône du logo/nom du site (optionnel) */
        footer .text-primary {
            color: var(--bs-primary) !important;
        }

        /* Assurer que le fond foncé est utilisé */
        .bg-dark {
            background-color: var(--bs-dark-background) !important;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">
    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">E-com</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="{% url 'index' %}">Accueil</a>
                        </li>
                    </ul>
                    <form class="d-flex" role="search">
                        <input class="form-control me-2" type="search" name="search-text" placeholder="Rechercher" aria-label="Search"/>
                        <button class="btn btn-outline-success" type="submit">Rechercher</button>
                    </form>
                    <i class="fas fa-shopping-cart m-3 btn btn-outline-success position-relative" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-content="Articles dans le panier..." id="cart-icon" data-bs-html="true">
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">{{ nbProduits }}</span>
                    </i>
                </div>
            </div>
        </nav>
    </header>
    <main class="flex-shrink-0 mt-5 pt-4">
        {% block content %}
        
        {% endblock %}
    </main>
    <footer class="bg-dark text-white pt-5 pb-4 footer">
        <div class="container">
            <div class="row text-center text-md-start">

                <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
                    <h5 class="text-uppercase mb-4 font-weight-bold text-primary">
                        E-com
                    </h5>
                    <p class="text-secondary">
                        Des produits de qualité, livrés rapidement. Votre satisfaction, notre priorité.
                    </p>
                </div>

                <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mt-3">
                    <h6 class="text-uppercase mb-4 font-weight-bold">
                        Navigation
                    </h6>
                    <p>
                        <a href="#!" class="text-white text-decoration-none">Nouvelles Collections</a>
                    </p>
                    <p>
                        <a href="#!" class="text-white text-decoration-none">Promotions</a>
                    </p>
                </div>

                <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mt-3">
                    <h6 class="text-uppercase mb-4 font-weight-bold">
                        Support
                    </h6>
                    <p>
                        <a href="#!" class="text-white text-decoration-none">Nous Contacter</a>
                    </p>
                    <p>
                        <a href="#!" class="text-white text-decoration-none">Livraison & Retours</a>
                    </p>
                </div>

                <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mt-3">
                    <h6 class="text-uppercase mb-4 font-weight-bold">
                        Contact & Suivez-nous
                    </h6>
                    <p>
                        <i class="fas fa-home me-3"></i> Paris, France
                    </p>
                    <p>
                        <i class="fas fa-envelope me-3"></i> contact@site.com
                    </p>
                    <div class="d-flex justify-content-center justify-content-md-start mt-4">
                        <a href="#!" class="text-white me-4"><i class="fab fa-facebook-f fa-lg"></i></a>
                        <a href="#!" class="text-white me-4"><i class="fab fa-twitter fa-lg"></i></a>
                        <a href="#!" class="text-white me-4"><i class="fab fa-instagram fa-lg"></i></a>
                        <a href="#!" class="text-white"><i class="fab fa-linkedin-in fa-lg"></i></a>
                    </div>
                </div>
            </div>

            <hr class="mb-4">

            <div class="row align-items-center">
                <div class="col-md-7 col-lg-8">
                    <p class="text-center text-md-start mb-0">
                        © 2025 E-com. Tous droits réservés.
                    </p>
                </div>
                <div class="col-md-5 col-lg-4 d-flex justify-content-center justify-content-md-end mt-2 mt-md-0">
                    <img src="[Lien_Vers_Paiement]" alt="Modes de paiement" style="max-height: 25px;">
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
    // Le code doit être enveloppé dans document.ready pour garantir que le DOM est chargé.
    $(document).ready(function() {
        
        // =================================================================
        //                 FONCTIONS UTILITAIRES (Portée Locale)
        // =================================================================
        
        /**
         * Récupère l'objet panier du localStorage de façon sûre.
         * @returns {Object} L'objet panier ou un objet vide {}.
         */
        function getPanier() {
            const storedPanier = localStorage.getItem("panier");
            // Utiliser un objet vide {} comme valeur par défaut, pas un tableau [].
            return storedPanier ? JSON.parse(storedPanier) : {};
        }

        /**
         * Sauvegarde l'objet panier dans le localStorage.
         * @param {Object} panier - L'objet panier à sauvegarder.
         */
        function savePanier(panier) {
            localStorage.setItem("panier", JSON.stringify(panier));
        }
        
        /**
         * Met à jour le compteur d'articles dans l'UI.
         * @param {Object} panier - L'objet panier.
         */
        function updateCartCount(panier) {
            // Utiliser Object.keys(panier).length pour compter les produits différents.
            const nbProduits = Object.keys(panier).length;
            $("#cart-count").text(nbProduits);
        }

        /**
         * Construit et met à jour le contenu de la popover du panier.
         * @param {Object} panier - L'objet panier avec {id: {qte, title, ...}}.
         */
        function showProductList(panier) {
            let panier_str = "";
            panier_str += "<h6 class='fw-bold'>Votre panier :</h6><hr class='my-2'>";

            // Vérifie si le panier est vide pour afficher un message
            if (Object.keys(panier).length === 0) {
                panier_str += "<p class='text-muted small'>Le panier est vide.</p>";
            } else {
                for (let productId in panier) {
                    // Utilisation de .title et .qte selon la nouvelle structure
                    panier_str += `<div>${panier[productId].title} - <span class='fw-bold'>${panier[productId].qte}</span> pièce(s)</div>`;
                }
                panier_str += "<hr class='my-2'>";
            }
            
            // Assurez-vous que la vue 'panier' est bien définie dans Django.
            // Notez l'utilisation de guillemets simples autour de la balise Django pour éviter les conflits de citation.
            panier_str += `<a href='{% url "panier" %}' class='btn btn-primary btn-sm w-100 mt-2'>Voir le panier</a>`;
            
            // Met à jour l'attribut data-bs-content de l'élément (cart-icon)
            document.getElementById("cart-icon").setAttribute("data-bs-content", panier_str);
        }

        // =================================================================
        //                 INITIALISATION & ÉVÉNEMENTS
        // =================================================================
        
        // 1. Initialisation au chargement de la page
        const panierInitial = getPanier();
        updateCartCount(panierInitial);
        showProductList(panierInitial); 
        
        // 2. Événement Clic sur le bouton "Ajouter au panier"
        $(".add-to-cart").click(function() {
            // S'assurer que l'ID est une chaîne pour les clés d'objet
            const productId = $(this).data("product-id").toString(); 
            let panier = getPanier();

            // Stocker l'élément DOM une seule fois
            const productTitleElement = document.getElementById("ptitle_" + productId);
            const productTitle = productTitleElement ? productTitleElement.innerHTML : 'Produit inconnu';
            const productPriceElement = document.getElementById("pprice_" + productId);
            const productPrice = productPriceElement ? productPriceElement.innerHTML : 'Prix inconnu';
            
            // Logique de mise à jour (légèrement simplifiée)
            if (panier.hasOwnProperty(productId)) {
                panier[productId].qte += 1;
            } else {
                panier[productId] = { 
                    id: productId,
                    qte: 1, 
                    title: productTitle,
                    price: productPrice
                };
            }
            
            savePanier(panier);

            // Mise à jour de l'UI
            updateCartCount(panier);
            // Utilisation d'une notification plus discrète que 'alert' si possible (Toast Bootstrap)
            console.log(`Produit ajouté au panier : ${productTitle} (Total: ${panier[productId].qte})`);
            
            // Mettre à jour la popover
            showProductList(panier); 
            
            // Re-initialiser la popover pour afficher le nouveau contenu
            const cartIconEl = document.getElementById('cart-icon');
            if (cartIconEl) {
                // Si la popover existe, la met à jour ou la crée
                const popover = bootstrap.Popover.getInstance(cartIconEl) || new bootstrap.Popover(cartIconEl, {
                    html: true,
                    sanitize: false,
                    content: document.getElementById("cart-icon").getAttribute("data-bs-content")
                });
                // Si la popover était affichée, force son affichage pour actualiser le contenu
                if (popover._isShown()) {
                    popover.hide();
                    popover.show();
                }
            }
        });

        // 3. Gestion de la Popover Bootstrap (Définition initiale)
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
        const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
            html: true, 
            sanitize: false 
        }));
    });
</script>

    {% block js %}

    {% endblock %}

</body>

</html>