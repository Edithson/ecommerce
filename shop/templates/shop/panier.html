{% extends 'shop/base.html' %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4 fw-bold">Votre Panier d'Achat</h1>

    {% if msg != None %}
        <div class="alert alert-success" role="alert">
            {{ msg }}
        </div>
    {% endif %}

    <div class="row">
        
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body p-0">
                    
                    <table class="table align-middle m-0">
                        <thead>
                            <tr class="table-light">
                                <th scope="col">Produit</th>
                                <th scope="col" class="text-center">Quantité</th>
                                <th scope="col" class="text-center">Prix</th>
                                <th scope="col" class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody id="cart-list">
                            
                        </tbody>
                        <tfoot>
                            <tr class="table-secondary">
                                <th colspan="3" class="text-start">Total Général</th>
                                <th class="text-center" id="grand-total">0 FCFA</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            {# Bouton de retour aux achats #}
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Continuer les achats
            </a>
            
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">
                    Récapitulatif de la Commande
                </div>
                <form method="POST" id="cmd-form">
                    {% csrf_token %}
                    <div class="card-body">
                        <input type="hidden" name="articles" id="articles-input">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="nom_prenom" id="floatingNomPrenom" placeholder="Nom et prénom" required>
                            <label for="floatingNomPrenom">Nom et prénom</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" name="email" id="floatingEmail" placeholder="Email" required>
                            <label for="floatingEmail">Email</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="adresse" id="floatingAdr" placeholder="Adresse complete" required>
                            <label for="floatingAdr">Adresse complete</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="telephone" id="floatingTel" placeholder="Téléphone" required>
                            <label for="floatingTel">Téléphone</label>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-success btn-lg w-100" id="valid-cmd-form" type="submit">
                            <i class="fas fa-lock me-2"></i> Passer à la Caisse
                        </button>
                        <p class="mt-2 text-center small text-muted">Paiement 100% sécurisé.</p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    $('#cmd-form').submit(function(e){
        e.preventDefault();
        localStorage.removeItem("panier");
        const form = this;
        form.submit();
    })
    document.addEventListener("DOMContentLoaded", function() {
        let articles = localStorage.getItem("panier") ? JSON.parse(localStorage.getItem("panier")) : {};
        if(!articles || Object.keys(articles).length === 0) {
            document.getElementById("valid-cmd-form").setAttribute("disabled", "disabled");
        }
        document.getElementById("articles-input").value = JSON.stringify(articles);
        let produitsDansPanier = Object.values(articles);
        produitsDansPanier.forEach(function(article, index) {
            let itemString = 
                `<tr>
                    <td>${article.title}</td>
                    <td class="text-center">${article.qte}</td>
                    <td class="text-center">${article.price}</td>
                    <td class="text-center">${(parseFloat(article.price) * article.qte).toFixed(0)} FCFA</td>
                </tr>`
            document.getElementById("cart-list").insertAdjacentHTML("beforeend", itemString);
        });
        let totalGeneral = produitsDansPanier.reduce((total, article) => {
            return total + (parseFloat(article.price) * article.qte);
        }, 0);
        document.getElementById("grand-total").innerText = totalGeneral.toFixed(0) + " FCFA";
    });
</script>
{% endblock %}
